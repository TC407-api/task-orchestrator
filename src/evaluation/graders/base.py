"""
Base classes for the grader system.

Defines the abstract base class for individual graders and the pipeline
logic for executing sequences of graders.
"""

from abc import ABC, abstractmethod
from typing import Any, List, Optional, Dict

from ..trial import GraderResult


class Grader(ABC):
    """
    Base class for all graders.

    Attributes:
        name (str): The identifier for this grader.
        weight (float): The weight of this grader in a weighted average scenario.
    """

    def __init__(self, name: str = "Grader", weight: float = 1.0):
        """
        Initialize the grader.

        Args:
            name: Unique identifier for the grader.
            weight: Importance weight (default 1.0).
        """
        self.name = name
        self.weight = weight

    @abstractmethod
    async def grade(self, output: Any, context: Dict[str, Any]) -> GraderResult:
        """
        Grade the output and return a result.

        Args:
            output: The output generated by the agent/system.
            context: Contextual data (e.g., input prompt, expected answers).

        Returns:
            GraderResult: The outcome of the grading process.
        """
        pass

    def _make_result(
        self, passed: bool, score: float, reason: str, **metadata: Any
    ) -> GraderResult:
        """
        Helper to construct a GraderResult object.

        Args:
            passed: Whether the check passed.
            score: Numerical score (0.0 to 1.0).
            reason: Explanation of the result.
            **metadata: Additional diagnostic information.

        Returns:
            GraderResult: Populated result object.
        """
        return GraderResult(
            name=self.name,
            passed=passed,
            score=score,
            reason=reason,
            metadata=metadata,
        )


class GraderPipeline:
    """
    Run multiple graders in sequence.

    Attributes:
        graders (List[Grader]): List of graders to execute.
    """

    def __init__(self, graders: Optional[List[Grader]] = None):
        """
        Initialize the pipeline.

        Args:
            graders: Initial list of graders.
        """
        self.graders = graders or []

    def add(self, grader: Grader) -> "GraderPipeline":
        """
        Add a grader to the pipeline.

        Args:
            grader: The grader instance to add.

        Returns:
            self: For method chaining.
        """
        self.graders.append(grader)
        return self

    async def run(self, output: Any, context: Dict[str, Any]) -> List[GraderResult]:
        """
        Execute all graders sequentially.

        Catches exceptions from individual graders to prevent pipeline failure.

        Args:
            output: The output to grade.
            context: Context dictionary.

        Returns:
            List[GraderResult]: List of results from all graders.
        """
        results = []
        for grader in self.graders:
            try:
                result = await grader.grade(output, context)
                results.append(result)
            except Exception as e:
                results.append(
                    GraderResult(
                        name=grader.name,
                        passed=False,
                        score=0.0,
                        reason=f"Grader error: {str(e)}",
                        metadata={"error_type": type(e).__name__},
                    )
                )
        return results
