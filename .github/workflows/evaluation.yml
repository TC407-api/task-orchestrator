name: Evaluation System CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

env:
  JWT_SECRET_KEY: test-secret-for-ci

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov flake8 mypy

      - name: Lint with Flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warnings (don't fail)
          flake8 src tests --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Type Check with Mypy
        run: |
          mypy src --ignore-missing-imports || true

      - name: Run Unit Tests with Coverage
        run: |
          pytest tests/test_evaluation.py tests/test_immune_system.py \
            --cov=src/evaluation \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            -v

      - name: Run Integration Tests
        run: |
          pytest tests/test_integration_cicd.py \
            -m integration \
            --cov=src/evaluation \
            --cov-append \
            --cov-report=xml \
            --cov-report=term-missing \
            -v

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        if: matrix.python-version == '3.11'

  evaluation-smoke-test:
    runs-on: ubuntu-latest
    needs: quality-gate

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Imports
        run: |
          python -c "
          from src.evaluation import (
              Trial, GraderResult, GraderPipeline,
              NonEmptyGrader, JSONValidGrader, LengthGrader,
              ModelGrader, RelevanceGrader, CompletenessGrader,
              CodeQualityGrader, SafetyGrader, PerformanceGrader,
              ImmuneSystem, get_immune_system,
          )
          from src.evaluation.immune_system import (
              ImmuneDashboard, create_dashboard,
          )
          print('All imports successful!')
          "

      - name: Verify Grader Pipeline
        run: |
          python -c "
          import asyncio
          from src.evaluation import GraderPipeline, NonEmptyGrader, LengthGrader

          async def test():
              pipeline = GraderPipeline([
                  NonEmptyGrader(),
                  LengthGrader(min_length=1, max_length=1000),
              ])
              results = await pipeline.evaluate('Hello World')
              assert all(r.passed for r in results), 'Pipeline should pass'
              print('Grader pipeline test passed!')

          asyncio.run(test())
          "

      - name: Verify Immune System
        run: |
          python -c "
          import asyncio
          from src.evaluation import get_immune_system, reset_immune_system

          async def test():
              reset_immune_system()
              immune = get_immune_system()

              response = await immune.pre_spawn_check('test prompt', 'spawn_agent')
              assert response.should_proceed, 'Should proceed for clean prompt'

              health = immune.get_health()
              assert health['status'] == 'healthy'
              print('Immune system test passed!')

          asyncio.run(test())
          "
